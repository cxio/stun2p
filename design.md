# STUN2 服务子网设计

## 组网

服务节点相互连接、分享信息，构建持续运行的STUN2服务子网（基于 p2p.New）。

网络主要采用基于 UDP 的 QUIC（Quick UDP Internet Connections） 协议，但也支持 HTTP2（TCP）连接提供客户端对自身公网地址（IP:Port）的简单探测。

提供的服务：

1. 探知客户端节点的公网地址（IP:Port）。支持 UDP 和 TCP。
2. 提供客户端节点 NAT 类型探测、NAT 映射生命期探测（仅限 UDP）。
3. 提供 UDP 打洞协助和信令协调服务。

> **注：**
> 只有NAT为 `Public` 或 `FullC` 类型的节点才能组网对外提供服务。


### 节点信息

- 名识：`stun2-service`。
- 协议：`quic`, `http2`。
- 地址：公网IP:Port，可以有多个。
- SPKI：证书的公钥信息指纹，即 sha256(SPKI)。
- NATT：NAT类型（`Public` | `FullC`）。
- Extra：无。


### 应用池

暂存各类应用节点的连接，提供同类或异类节点间的*UDP打洞协助*（信令中介），以及可能需要的持续*信令协调*。

打洞协助所支持的*应用类型*由服务节点自己配置取舍。这是 P2P 的自由，也无法约束。

应用池大小限制可能为 **500**（应可配置）。

> **注：**
> 异类身份节点间的连接是可能的，比如组队校验中的*校验员*和*守卫者*存在协作。


### 节点搜寻

因为对*应用类型*的支持是由服务节点自己决定的，这是离散的，没有统一的约束。所以一个寻求打洞支持的客户端需要*搜寻*支持本应用类型的服务节点。

这种搜寻与基网的节点搜寻类似，但客户端仅需要找到目标服务节点即可，并不需要创建一个*相同类型服务节点的子网*。

> **注意：**
> 应用客户端在请求服务节点协助打洞前，应当已经知道自己的*NAT*情形。


## 经济激励

当服务节点接受应用节点的连入时，会提供一个区块链地址，用于接收可能有的回报。

如果应用节点为区块链类型，发送的就是该区块链的地址，否则会是一个通用的区块链（如比特币或以太坊）地址。

并不能保证一定有回报，但区块链全网直付的便利还是要用一下的 :)


## 打洞协助

打洞协助由应用池负责。

应用池中保留了节点的连接和节点信息。根据请求，服务节点为它们互传必要的信息（中介信令），从而协调双方打洞互连。


### 基本规则

遵循两端同时监听和拨号（Listen + Dial）同时打洞的原则（**注**：应对“半开口子”NAT）。

双方最终的主从关系由节点动态生成的序列号判断：大者监听（Listen），小者拨号（Dial）。如果两个序列号相同（概率极低），则用双方的IP地址对比，规则相同。


### 消息包

打洞双方沟通的消息，包含了相互指向的地址，以及识别标识。

```go
Message {
	IP      bytes  	// 对端公网IP
	Port    int  	// 对端公网端口
	Token   bytes  	// 会话标识（也用于主从判断）
    NATT    int     // 对端NAT类型（参考）
}
```

> **注：**
> 打洞仅用于 QUIC（UDP） 连接。


### 定向打洞

请求服务器对指定的目标地址协助打洞。

这需要目标地址对应的节点已经与服务器建立了连接（即在应用池中），同时服务器也支持该功能。

定向打洞需要明确获知与目标节点连接的服务节点，这通常由目标节点通过某种方式来提供。比如在数据网（depots）中搜寻目标数据，拥有该数据的节点会在原路返回的回复包中，提供其连入的STUN2服务节点的信息（以及自己的ID）。

> **实现：**
> 提供定向打洞协助的服务器需创建一个连接映射表，用于从目标ID检索目标节点的连接。


### 信令协调

提供了打洞协助的服务节点，会保留双方的连接，以提供持续的“信令协调”服务。

比如：如果其中一个节点被改变了外网的NAT映射，服务器应当协助两个节点重新建立连接，以维持其正常通讯。


### 例外：`Sym --> Public/FullC`

对称型节点端口不确定，无法参与打洞协作，因此只能向外与 `Public/FullC` 建立连接（单向）。



## 服务可见性

### 服务群（抽象）

服务节点会向应用提供自己的区块链收益地址，但通常只有服务质量好时，才可能收到回报。

所以知名度是有意义的。

抽象的服务群是：*只要服务节点提供同一个收益地址，它们就会被视为一个群*，并无真正的物理群连接，也无认证机制。


### 群成员辩识

为便于区分服务群里的成员，以方便某种管理，这里增加了一个**身份ID**的逻辑，标识具体的服务节点。

因此服务节点向应用客户端提供的回报地址包含两个部分：区块链 `收益地址 + 身份ID`。

身份ID由服务节点自己定义，考虑简单性，身份ID通常也是一个区块链地址，这样唯一性就自然而然了。



## 附注

### 通用广播查找

本服务仅实现根据*应用类型*对服务节点的广播查找，不支持根据*应用客户端ID*对其所连接的服务节点的查找（比如定向打洞，可以藉此简单查找目标服务节点。这里不支持）。

这是一种简化设计，因为应用节点在提供自身ID的同时，也可以很方便地提供其所连接服务节点的信息。
